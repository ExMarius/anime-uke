<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrmƒÉre»ôte - AnimeUKE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0a0a0a; color: white; font-family: 'Segoe UI', sans-serif; }
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            margin-bottom: 20px;
        }
        .episode-list { max-height: 70vh; overflow-y: auto; }
        .episode-item {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .episode-item:hover { background: rgba(230, 57, 70, 0.15); }
        .episode-item.active {
            background: rgba(230, 57, 70, 0.25);
            border-left: 4px solid #e63946;
            font-weight: bold;
        }
        .auto-next-toggle {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark py-3 shadow">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-play-circle me-2"></i>AnimeUKE
            </a>
            <a href="/" class="btn btn-outline-light">
                <i class="fas fa-home me-2"></i>AcasƒÉ
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Player -->
            <div class="col-lg-8 mb-4">
                <div class="video-container">
                    <div class="ratio ratio-16x9">
                        <iframe id="video-player" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="episode-title" class="mb-0">Se √ÆncarcƒÉ...</h4>
                    <div class="form-check form-switch auto-next-toggle">
                        <input class="form-check-input" type="checkbox" id="autoNext" checked>
                        <label class="form-check-label" for="autoNext">Auto UrmƒÉtor</label>
                    </div>
                </div>
                <p id="episode-description" class="text-muted"></p>

                <div class="d-flex gap-3 mt-4">
                    <button id="prev-ep" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-chevron-left me-2"></i>Anterior
                    </button>
                    <button id="next-ep" class="btn btn-outline-light btn-lg">
                        UrmƒÉtor<i class="fas fa-chevron-right ms-2"></i>
                    </button>
                </div>
            </div>

            <!-- Lista Episoade -->
            <div class="col-lg-4">
                <div class="card bg-dark border-secondary shadow">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Episoade One Piece</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="episode-list" id="episode-list">
                            <div class="p-4 text-center"><div class="spinner-border text-danger"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const animeSlug = urlParams.get('anime') || 'one-piece';
        const currentEpNum = parseInt(urlParams.get('ep')) || 1;

        let episodes = [];
        let currentEpisode = null;

        // Auto-next activat implicit
        const autoNextEnabled = () => document.getElementById('autoNext').checked;

        async function loadEpisodes() {
            const res = await fetch('/episodes.json');
            episodes = await res.json();
            const onePieceEps = episodes
                .filter(e => e.animeSlug === 'one-piece')
                .sort((a, b) => a.number - b.number);

            currentEpisode = onePieceEps.find(e => e.number === currentEpNum);
            if (!currentEpisode) {
                document.body.innerHTML = `<div class="container text-center mt-5"><h1>Episod negƒÉsit</h1><a href="/" class="btn btn-danger mt-3">√énapoi acasƒÉ</a></div>`;
                return;
            }

            loadPlayer();
            loadEpisodeList(onePieceEps);
            setupNavigation(onePieceEps);
        }

        function loadPlayer() {
            document.getElementById('episode-title').textContent = 
                `Episod ${currentEpisode.number}: ${currentEpisode.title}`;
            document.getElementById('episode-description').textContent = 
                currentEpisode.description || 'FƒÉrƒÉ descriere.';

            const iframe = document.getElementById('video-player');
            iframe.src = currentEpisode.sources[0];

            // AUTO-NEXT: DetectƒÉm c√¢nd se terminƒÉ videoclipul
            iframe.onload = () => {
                const checkEnd = setInterval(() => {
                    try {
                        // Filemoon expune player API √Æn window.parent uneori
                        const player = iframe.contentWindow;
                        if (player && player.player) {
                            const duration = player.player.duration();
                            const current = player.player.currentTime();
                            if (duration && current && duration - current < 8 && autoNextEnabled()) {
                                clearInterval(checkEnd);
                                goToNextEpisode();
                            }
                        }
                    } catch(e) {
                        // DacƒÉ nu putem accesa iframe-ul (CORS), folosim backup
                    }
                }, 3000);

                // Backup: dacƒÉ utilizatorul apasƒÉ pe sf√¢r»ôitul videoclipului (90%+)
                iframe.contentWindow.addEventListener('timeupdate', function checkTime() {
                    if (iframe.contentWindow.player) {
                        const percent = iframe.contentWindow.player.currentTime() / iframe.contentWindow.player.duration();
                        if (percent > 0.95 && autoNextEnabled()) {
                            iframe.contentWindow.removeEventListener('timeupdate', checkTime);
                            setTimeout(goToNextEpisode, 1500);
                        }
                    }
                });
            };

            // AlternativƒÉ 100% sigurƒÉ: detectƒÉm c√¢nd URL-ul are ?ended=1 (Filemoon face asta uneori)
            window.addEventListener('message', (event) => {
                if (event.data === 'video-ended' || event.data?.type === 'ended') {
                    if (autoNextEnabled()) goToNextEpisode();
                }
            });
        }

        function loadEpisodeList(allEps) {
            const container = document.getElementById('episode-list');
            container.innerHTML = '';

            allEps.forEach(ep => {
                const div = document.createElement('div');
                div.className = `episode-item ${ep.number === currentEpNum ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Episod ${ep.number}</strong><br>
                            <small class="text-muted">${ep.title || 'FƒÉrƒÉ titlu'}</small>
                        </div>
                        ${ep.number === currentEpNum ? '<i class="fas fa-play-circle text-danger"></i>' : ''}
                    </div>
                `;
                div.onclick = () => {
                    window.location.href = `/watch.html?anime=one-piece&ep=${ep.number}`;
                };
                container.appendChild(div);
            });
        }

        function setupNavigation(allEps) {
            const currentIndex = allEps.findIndex(e => e.number === currentEpNum);

            const prevBtn = document.getElementById('prev-ep');
            const nextBtn = document.getElementById('next-ep');

            if (currentIndex <= 0) {
                prevBtn.disabled = true;
                prevBtn.innerHTML = '<i class="fas fa-chevron-left me-2"></i>Primul episod';
            } else {
                prevBtn.onclick = () => {
                    window.location.href = `/watch.html?anime=one-piece&ep=${allEps[currentIndex - 1].number}`;
                };
            }

            if (currentIndex >= allEps.length - 1) {
                nextBtn.disabled = true;
                nextBtn.innerHTML = 'Ultimul episod<i class="fas fa-chevron-right ms-2"></i>';
            } else {
                nextBtn.onclick = () => goToNextEpisode();
            }
        }

        function goToNextEpisode() {
            const nextEp = episodes.find(e => 
                e.animeSlug === 'one-piece' && e.number === currentEpisode.number + 1
            );
            if (nextEp) {
                window.location.href = `/watch.html?anime=one-piece&ep=${nextEp.number}`;
            } else {
                alert('Ai terminat toate episoadele disponibile! FelicitƒÉri! üè¥‚Äç‚ò†Ô∏è');
            }
        }

        // Pornim totul
        loadEpisodes();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
